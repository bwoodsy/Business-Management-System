<section class="inventory">
  <div class="page-head">
    <div>
      <p class="eyebrow">Inventory</p>
      <h2>Products</h2>
      <p class="subhead">Track stock levels, value, and category flow in one place.</p>
    </div>
    <div class="actions">
      <div class="search">
        <input
          type="search"
          placeholder="Search by name or category"
          [value]="query()"
          (input)="query.set($any($event.target).value)"
        />
      </div>
      <button class="primary" type="button" (click)="toggleForm()">
        {{ showForm() ? 'Close' : 'Add product' }}
      </button>
    </div>
  </div>

  <div class="stats">
    <div class="stat">
      <div class="stat-label">Products</div>
      <div class="stat-value">{{ stats().count }}</div>
    </div>
    <div class="stat">
      <div class="stat-label">Total stock</div>
      <div class="stat-value">{{ stats().totalStock }}</div>
    </div>
    <div class="stat">
      <div class="stat-label">Inventory value</div>
      <div class="stat-value">{{ formatMoney(stats().inventoryValue) }}</div>
    </div>
    <div class="stat">
      <div class="stat-label">Low stock items</div>
      <div class="stat-value">{{ stats().lowStock }}</div>
    </div>
  </div>

  <div class="form-card" *ngIf="showForm()">
    <div class="form-head">
      <div>
        <h3>New inventory item</h3>
        <p>Add stock straight to the inventory list.</p>
      </div>
      <button class="ghost" type="button" (click)="toggleForm()">Hide</button>
    </div>

    <div class="field-grid">
      <label class="field">
        <span>Name</span>
        <input [(ngModel)]="newProduct.name" [ngModelOptions]="{standalone: true}" />
      </label>
      <label class="field">
        <span>Category</span>
        <select [(ngModel)]="newProduct.categoryId" [ngModelOptions]="{standalone: true}">
          <option [ngValue]="0">Select category</option>
          <option *ngFor="let category of categories()" [ngValue]="category.id">
            {{ category.name }}
          </option>
        </select>
      </label>
    </div>

    <div class="field-grid">
      <label class="field">
        <span>Price</span>
        <input type="number" min="0" step="0.01" [(ngModel)]="newProduct.price" [ngModelOptions]="{standalone: true}" />
      </label>
      <label class="field">
        <span>Starting stock</span>
        <input type="number" min="0" step="1" [(ngModel)]="newProduct.stock" [ngModelOptions]="{standalone: true}" />
      </label>
    </div>

    <button class="primary" type="button" (click)="submitProduct()" [disabled]="creating()">
      {{ creating() ? 'Saving...' : 'Save product' }}
    </button>

    <div class="divider"></div>

    <div class="inline-category">
      <label class="field">
        <span>Need a new category?</span>
        <input [(ngModel)]="newCategory.name" [ngModelOptions]="{standalone: true}" placeholder="Category name" />
      </label>
      <button class="ghost" type="button" (click)="submitCategory()">Add category</button>
    </div>

    <div class="form-message" *ngIf="formMessage()">{{ formMessage() }}</div>
  </div>

  <div class="state" *ngIf="loading()">Loading products...</div>
  <div class="state error" *ngIf="error()">{{ error() }}</div>

  <div *ngIf="!loading() && !error()">
    <div class="empty" *ngIf="filteredProducts().length === 0">
      <p>No products match your search.</p>
    </div>

    <div class="table" *ngIf="filteredProducts().length > 0">
      <div class="table-head">
        <span>Name</span>
        <span>Category</span>
        <span>Price</span>
        <span>Stock</span>
        <span>Value</span>
        <span>Actions</span>
      </div>
      <ng-container *ngFor="let p of filteredProducts(); trackBy: trackById">
        <div class="table-row">
          <div class="cell title">
            <span class="title-main">{{ p.name }}</span>
            <span class="title-sub">SKU {{ p.id }}</span>
          </div>
          <div class="cell">{{ p.categoryName || 'Unassigned' }}</div>
          <div class="cell">{{ formatMoney(p.price) }}</div>
          <div class="cell">
            <span class="pill" [class.low]="p.stock <= 5">{{ p.stock }}</span>
          </div>
          <div class="cell">{{ formatMoney(p.price * p.stock) }}</div>
          <div class="cell actions-cell">
            <button class="ghost small" type="button" (click)="startEdit(p)" [disabled]="savingEdit()">
              Edit
            </button>
          </div>
        </div>
        <div class="table-row edit-row" *ngIf="editingId() === p.id">
          <div class="cell edit-cell">
            <div class="edit-grid">
              <label class="field">
                <span>Name</span>
                <input [(ngModel)]="editProduct.name" [ngModelOptions]="{standalone: true}" />
              </label>
              <label class="field">
                <span>Category</span>
                <select [(ngModel)]="editProduct.categoryId" [ngModelOptions]="{standalone: true}">
                  <option [ngValue]="0">Select category</option>
                  <option *ngFor="let category of categories()" [ngValue]="category.id">
                    {{ category.name }}
                  </option>
                </select>
              </label>
              <label class="field">
                <span>Price</span>
                <input
                  type="number"
                  min="0"
                  step="0.01"
                  [(ngModel)]="editProduct.price"
                  [ngModelOptions]="{standalone: true}"
                />
              </label>
              <label class="field">
                <span>Stock</span>
                <input
                  type="number"
                  min="0"
                  step="1"
                  [(ngModel)]="editProduct.stock"
                  [ngModelOptions]="{standalone: true}"
                />
              </label>
            </div>
            <div class="edit-actions">
              <button class="primary" type="button" (click)="saveEdit(p)" [disabled]="savingEdit()">
                {{ savingEdit() ? 'Saving...' : 'Save changes' }}
              </button>
              <button class="ghost" type="button" (click)="cancelEdit()" [disabled]="savingEdit()">
                Cancel
              </button>
            </div>
            <div class="form-message" *ngIf="editMessage()">{{ editMessage() }}</div>
          </div>
        </div>
      </ng-container>
    </div>
  </div>
</section>
